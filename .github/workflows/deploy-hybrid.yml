name: Deploy Static Site

on:
  push:
    branches: [master, main]
  workflow_dispatch:

env:
  NODE_VERSION: "18"
  AWS_REGION: "us-east-1"
  S3_BUCKET: ${{ secrets.S3_BUCKET }}
  CLOUDFRONT_DISTRIBUTION_ID: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}
  NEXT_PUBLIC_APP_RUNNER_URL: ${{ secrets.NEXT_PUBLIC_APP_RUNNER_URL }}

jobs:
  deploy-static:
    name: üåê Deploy Static Site
    runs-on: ubuntu-latest
    steps:
      - name: üõéÔ∏è Checkout code
        uses: actions/checkout@v4

      - name: üèóÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: üì¶ Install dependencies
        run: npm ci

      - name: üî® Build static site
        run: |
          echo "Building hybrid static site..."
          echo "Using App Runner URL: ${NEXT_PUBLIC_APP_RUNNER_URL:-'Not set'}"
          # Build with the hybrid config (already in next.config.js)
          npm run build
          echo "‚úÖ Static build complete!"
        env:
          NEXT_PUBLIC_APP_RUNNER_URL: ${{ secrets.NEXT_PUBLIC_APP_RUNNER_URL }}

      - name: üîß Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: üì§ Deploy static files to S3
        run: |
          echo "Deploying static files to S3..."

          # Sync static files with optimized caching
          aws s3 sync out/ s3://$S3_BUCKET \
            --delete \
            --cache-control "public,max-age=31536000,immutable" \
            --exclude "*.html" \
            --exclude "*.json"

          # HTML files with shorter cache for updates
          aws s3 sync out/ s3://$S3_BUCKET \
            --cache-control "public,max-age=1800" \
            --exclude "*" \
            --include "*.html" \
            --include "*.json"

      - name: üåê Invalidate CloudFront
        if: env.CLOUDFRONT_DISTRIBUTION_ID != ''
        run: |
          echo "Invalidating CloudFront distribution: $CLOUDFRONT_DISTRIBUTION_ID"
          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id $CLOUDFRONT_DISTRIBUTION_ID \
            --paths "/*" \
            --query 'Invalidation.Id' \
            --output text)

          echo "‚úÖ CloudFront invalidation started: $INVALIDATION_ID"

  notify:
    name: ‚úÖ Deployment Complete
    runs-on: ubuntu-latest
    needs: [deploy-static]
    steps:
      - name: üéâ Success notification
        run: |
          echo "üéâ Static site deployment completed successfully!"
          echo ""
          echo "üåê Static Site: Fast loading from CDN"
          echo "‚ö° API: AWS App Runner (always warm, no cold starts)"
          echo "üí∞ Cost: Low cost static hosting + App Runner"
          echo "üöÄ Performance: Fast and reliable!"
          echo ""
          echo "‚úÖ Site is live and ready!"
