name: Deploy App Runner

on:
  workflow_dispatch:  # Manual trigger only
  push:
    branches: [master, main]
    paths:
      - 'api-server/**'
      - 'api/**'
      - '.github/workflows/deploy-app-runner.yml'

env:
  AWS_REGION: "us-east-1"
  SERVICE_NAME: "didlionswin-api"
  ECR_REPO_NAME: "didlionswin-api"

jobs:
  deploy-app-runner:
    name: ğŸš€ Deploy App Runner
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ›ï¸ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸ“¦ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: ğŸ—ï¸ Build, tag, and push image to Amazon ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ env.ECR_REPO_NAME }}
          IMAGE_TAG: latest
        run: |
          # Create ECR repository if it doesn't exist
          aws ecr describe-repositories --repository-names $ECR_REPOSITORY --region ${{ env.AWS_REGION }} || \
          aws ecr create-repository --repository-name $ECR_REPOSITORY --region ${{ env.AWS_REGION }} --image-scanning-configuration scanOnPush=true

          # Build and push Docker image
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG -f api-server/Dockerfile .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG

          echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: ğŸš€ Deploy to App Runner
        id: deploy
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          ECR_REPOSITORY: ${{ env.ECR_REPO_NAME }}
        run: |
          # Get AWS account ID
          AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          IMAGE_URI="${AWS_ACCOUNT_ID}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${ECR_REPOSITORY}:latest"
          
          # Check if App Runner service exists
          SERVICE_ARN=$(aws apprunner list-services \
            --region ${{ env.AWS_REGION }} \
            --query "ServiceSummaryList[?ServiceName=='${{ env.SERVICE_NAME }}'].ServiceArn" \
            --output text 2>/dev/null || echo "")

          if [ -z "$SERVICE_ARN" ]; then
            echo "ğŸ†• Creating new App Runner service..."
            
            # Create service configuration
            cat > /tmp/apprunner-config.json <<EOF
          {
            "ServiceName": "${{ env.SERVICE_NAME }}",
            "SourceConfiguration": {
              "ImageRepository": {
                "ImageIdentifier": "${IMAGE_URI}",
                "ImageRepositoryType": "ECR",
                "ImageConfiguration": {
                  "Port": "8080",
                  "RuntimeEnvironmentVariables": {
                    "NODE_ENV": "production",
                    "ESPN_API_URL": "https://sports.core.api.espn.com/v2/sports/football/leagues/nfl",
                    "LIONS_TEAM_ID": "8"
                  }
                }
              },
              "AutoDeploymentsEnabled": true
            },
            "InstanceConfiguration": {
              "Cpu": "0.5 vCPU",
              "Memory": "1 GB"
            },
            "HealthCheckConfiguration": {
              "Protocol": "HTTP",
              "Path": "/api/health",
              "Interval": 10,
              "Timeout": 5,
              "HealthyThreshold": 1,
              "UnhealthyThreshold": 5
            }
          }
          EOF

            aws apprunner create-service \
              --region ${{ env.AWS_REGION }} \
              --cli-input-json file:///tmp/apprunner-config.json

            echo "âœ… Service created! It may take a few minutes to become available."
          else
            echo "ğŸ”„ Updating existing App Runner service..."
            aws apprunner start-deployment \
              --service-arn "$SERVICE_ARN" \
              --region ${{ env.AWS_REGION }}
            
            echo "âœ… Deployment started! The service will update automatically."
          fi

      - name: ğŸ“ Get App Runner URL
        id: get-url
        run: |
          sleep 10  # Wait a bit for service to be ready
          SERVICE_URL=$(aws apprunner list-services \
            --region ${{ env.AWS_REGION }} \
            --query "ServiceSummaryList[?ServiceName=='${{ env.SERVICE_NAME }}'].ServiceUrl" \
            --output text)
          
          if [ -n "$SERVICE_URL" ]; then
            echo "url=$SERVICE_URL" >> $GITHUB_OUTPUT
            echo "âœ… App Runner URL: $SERVICE_URL"
            echo ""
            echo "ğŸ“ Next step: Add this URL to GitHub Secrets as NEXT_PUBLIC_APP_RUNNER_URL"
          else
            echo "â³ Service URL not available yet. Check AWS Console or run get-url.sh later."
          fi

      - name: âœ… Deployment Summary
        run: |
          echo "ğŸ‰ App Runner deployment complete!"
          echo ""
          echo "ğŸ“ Service: ${{ env.SERVICE_NAME }}"
          echo "ğŸŒ URL: ${{ steps.get-url.outputs.url }}"
          echo ""
          echo "ğŸ“ Don't forget to:"
          echo "   1. Get the App Runner URL (from AWS Console or run get-url.sh)"
          echo "   2. Add it to GitHub Secrets as NEXT_PUBLIC_APP_RUNNER_URL"
          echo "   3. Next frontend deployment will use App Runner!"

